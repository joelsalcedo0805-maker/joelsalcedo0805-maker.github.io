<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="manifest" href="./manifest.json">
<link rel="icon" href="icons/icon-192.png">
<meta name="theme-color" content="#ff0000">

<script>
  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("./service-worker.js");
  }
</script>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Janet Shop ‚Äî Bakery POS</title>
<style>
:root{
  --bg:#f6efe6;
  --card:#fff9f2;
  --muted:#6b5b45;
  --accent:#c07b2f; /* warm brown */
  --accent-2:#f3c46b; /* soft yellow */
  --wood:#6a4b2a;
  --success:#2e7d32;
  --danger:#c62828;
}
*{box-sizing:border-box}
body{
  font-family: "Segoe UI", Roboto, Arial, sans-serif;
  margin:0; padding:18px;
  background: linear-gradient(180deg,#fbf7f1 0%, #f2eadf 40%), url('') center/cover no-repeat;
  color:var(--wood);
}

/* Header */
header{display:flex;align-items:center;justify-content:space-between;gap:16px;margin-bottom:18px}
.brand{display:flex;align-items:center;gap:12px}
.logo{
  width:68px;height:68px;border-radius:12px;
  background:linear-gradient(135deg,#fff8f0,#fff3e1);
  display:flex;align-items:center;justify-content:center;font-size:30px;border:2px solid rgba(106,75,42,0.08);
  box-shadow:0 6px 18px rgba(106,75,42,0.06);
}
h1{margin:0;font-size:22px}
.subtitle{font-size:13px;color:var(--muted)}

/* layout */
.container{display:grid;grid-template-columns:1.4fr 1fr 0.95fr;gap:18px}
.card{background:var(--card);padding:14px;border-radius:12px;box-shadow:0 6px 18px rgba(106,75,42,0.06);border:1px solid rgba(106,75,42,0.06)}
.products .product{display:flex;align-items:center;gap:12px;padding:10px;border-radius:8px;border:1px solid rgba(106,75,42,0.06);margin-bottom:10px;background:linear-gradient(180deg,#fffaf3,#fff6ec)}
.thumbnail{width:54px;height:54px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:28px;background:linear-gradient(135deg,#fff6e8,#fff3de);border:1px solid rgba(106,75,42,0.04)}
.prod-info{flex:1}
.prod-name{font-weight:700;color:var(--wood)}
.prod-price{color:var(--muted);font-size:13px;margin-top:4px}
.qty-controls{display:flex;gap:6px;align-items:center}
.btn{padding:8px 12px;border:0;border-radius:10px;background:var(--wood);color:#fff;font-weight:700;cursor:pointer}
.btn.secondary{background:transparent;border:1px solid rgba(106,75,42,0.12);color:var(--wood);font-weight:700}
.small{padding:6px 8px;border-radius:8px}
.inline-input{padding:8px;border-radius:10px;border:1px solid rgba(106,75,42,0.12);width:100%}
.cart-table{width:100%;border-collapse:collapse;margin-top:8px}
.cart-table th,.cart-table td{padding:8px;border-bottom:1px dashed rgba(106,75,42,0.06);text-align:left}
.center{text-align:center}
.muted{color:var(--muted);font-size:13px}
.totals{font-size:20px;font-weight:800;color:var(--wood)}
.controls{display:flex;gap:10px;align-items:center;flex-wrap:wrap}

/* POS Tools column */
.tools .muted{font-size:13px}

/* receipt (hidden but printable) */
#receiptArea{display:none}
@media print {
  body *{visibility:hidden}
  #printableReceipt, #printableReceipt *{visibility:visible}
  #printableReceipt{position:fixed;left:0;top:0;width:100%;font-family:monospace}
}

/* responsive */
@media (max-width:1100px){
  .container{grid-template-columns:1fr;gap:14px}
}
</style>
</head>
<body>

<header>
  <div class="brand">
    <div class="logo">ü•ê</div>
    <div>
      <h1>Janet Shop ‚Äî Bakery POS</h1>
      <div class="subtitle">Warm, simple POS ‚Ä¢ Currency: ‚Ç± (Philippine Peso)</div>
    </div>
  </div>

  <div style="display:flex;gap:12px;align-items:center">
    <div style="display:flex;flex-direction:column;gap:6px">
      <label class="muted">Barcode / SKU</label>
      <input id="barcodeInput" class="inline-input" placeholder="Scan code + Enter" style="min-width:220px">
    </div>

    <div style="display:flex;flex-direction:column;gap:6px">
      <label class="muted">VAT 12%</label>
      <input id="vatToggle" type="checkbox" checked>
    </div>

    <div style="display:flex;flex-direction:column;gap:6px;min-width:200px">
      <label class="muted">Discount</label>
      <select id="discountSelect" class="inline-input">
        <option value="0">None</option>
        <option value="0.20">Senior (20%)</option>
        <option value="0.20">PWD (20%)</option>
        <option value="0.10">Employee (10%)</option>
        <option value="custom">Custom %...</option>
      </select>
      <input id="customDiscount" class="inline-input" placeholder="Custom %" style="display:none;margin-top:6px">
    </div>
  </div>
</header>

<main class="container">
  <!-- Products -->
  <section class="card products">
    <h3 style="margin-top:0">Bakery Items</h3>
    <div style="margin-bottom:8px">
      <input id="searchInput" class="inline-input" placeholder="Search products (name or id)" oninput="renderProducts()" />
    </div>
    <div id="productsList"></div>
  </section>

  <!-- Cart -->
  <section class="card">
    <h3 style="margin-top:0">Cart</h3>

    <table class="cart-table">
      <thead>
        <tr><th>Item</th><th class="center">Qty</th><th class="center">Price</th><th class="center">Subtotal</th><th></th></tr>
      </thead>
      <tbody id="cartBody"></tbody>
    </table>

    <div style="display:flex;justify-content:space-between;align-items:center;margin-top:12px">
      <div>
        <button class="btn secondary small" onclick="clearCart()">Clear Cart</button>
        <button class="btn small" onclick="saveCart()">Save Cart</button>
      </div>
      <div style="text-align:right">
        <div class="muted">Subtotal: <span id="subTotalText">‚Ç±0.00</span></div>
        <div class="muted">Discount: <span id="discountText">‚Ç±0.00</span></div>
        <div class="muted">VAT (12%): <span id="vatText">‚Ç±0.00</span></div>
        <div class="totals">Total: <span id="totalText">‚Ç±0.00</span></div>
      </div>
    </div>

    <div style="margin-top:12px;display:flex;gap:10px;align-items:center">
      <input id="paymentInput" type="number" class="inline-input" placeholder="Payment amount (‚Ç±)" step="0.01" style="min-width:160px">
      <button class="btn" onclick="processPayment()">Pay</button>
      <div id="paymentResult" style="font-size:14px"></div>
    </div>

    <div style="margin-top:14px;color:var(--muted);font-size:13px">
      Saved in browser: <strong id="savedStatus">No</strong>
    </div>
  </section>

  <!-- Tools & Inventory -->
  <section class="card tools">
    <h3 style="margin-top:0">POS Tools</h3>

    <div style="display:flex;flex-direction:column;gap:10px">
      <div>
        <button class="btn small" onclick="printReceiptFromLast()">Print Last Receipt</button>
        <button class="btn small secondary" onclick="exportProducts()">Export Products</button>
        <button class="btn small secondary" onclick="importDemoCart()">Load Demo Cart</button>
      </div>

      <div>
        <h4 style="margin:6px 0">Inventory</h4>
        <div id="inventoryList" class="muted" style="font-size:13px"></div>
      </div>

      <div>
        <h4 style="margin:6px 0">Notes</h4>
        <div class="muted" style="font-size:13px">All currency shows ‚Ç±. VAT and discounts calculated on subtotal. Use barcode for quick add.</div>
      </div>
    </div>
  </section>
</main>

<!-- Hidden printable receipt -->
<div id="receiptArea">
  <div id="printableReceipt" style="width:320px;padding:18px;background:#fff"></div>
</div>

<script>
/* ===== DATA (products + barcode) ===== */
const products = [
  { id: 'p001',name: 'Monay', price: 1.00, emoji:'ü•ê', stock: 20, barcode: '1001' },
  { id: 'p002', name: 'Pandesal', price: 0.50, emoji:'üçû', stock: 50, barcode: '1002' },
  { id: 'p003', name: 'Hopia', price: 2.30, emoji:'ü•Ø', stock: 10, barcode: '1003' },
  { id: 'p004', name: 'Spanish Bread', price: 1.80, emoji:'üç©', stock: 15, barcode: '1004' },
  { id: 'p005', name: 'Purong Tapang 3in1', price: 1.00, emoji:'‚òï', stock: 30, barcode: '2001' },
  { id: 'p006', name: 'Kopiko Blanca', price: 0.50, emoji:'üßã', stock: 25, barcode: '2002' },
  { id: 'p007', name: 'Milk', price: 2.30, emoji:'ü•õ', stock: 12, barcode: '2003' },
  { id: 'p008', name: 'Milo', price: 1.80, emoji:'üç´', stock: 13, barcode: '2004' }
];
const barcodeMap = {};
products.forEach(p => barcodeMap[p.barcode] = p.id);

/* ===== STATE ===== */
let cart = []; // {id, qty}
let lastReceipt = null;

/* ===== HELPERS ===== */
function currency(v){ return '‚Ç±' + Number(v || 0).toFixed(2); }
function findProduct(id){ return products.find(p=>p.id===id); }
function findProductByBarcode(code){ const id = barcodeMap[code]; return id ? findProduct(id) : null; }

/* ===== persist in localStorage ===== */
function saveCart(){
  try {
    localStorage.setItem('bakery_pos_cart', JSON.stringify(cart));
    localStorage.setItem('bakery_pos_products', JSON.stringify(products));
    document.getElementById('savedStatus').innerText = 'Yes';
    alert('Cart saved in browser.');
  } catch(e){
    console.warn('Save failed', e);
  }
}
function loadCartFromStorage(){
  try {
    const raw = localStorage.getItem('bakery_pos_cart');
    const prodRaw = localStorage.getItem('bakery_pos_products');
    if(prodRaw){
      const prodSaved = JSON.parse(prodRaw);
      prodSaved.forEach(s => {
        const p = products.find(x=>x.id===s.id);
        if(p && typeof s.stock === 'number') p.stock = s.stock;
      });
    }
    if(raw){
      cart = JSON.parse(raw);
      document.getElementById('savedStatus').innerText = 'Yes';
    } else {
      document.getElementById('savedStatus').innerText = 'No';
    }
  } catch(e){ console.error('Load failed', e); }
}

/* ===== render products list ===== */
function renderProducts(){
  const q = document.getElementById('searchInput').value.trim().toLowerCase();
  const container = document.getElementById('productsList');
  container.innerHTML = '';
  products
    .filter(p => p.name.toLowerCase().includes(q) || p.id.includes(q))
    .forEach(p => {
      const el = document.createElement('div');
      el.className = 'product';
      el.innerHTML = `
        <div class="thumbnail">${p.emoji}</div>
        <div class="prod-info">
          <div class="prod-name">${p.name} <span class="muted">(${p.id})</span></div>
          <div class="prod-price">Price: ${currency(p.price)} ‚Ä¢ Stock: ${p.stock}</div>
        </div>
        <div style="display:flex;flex-direction:column;gap:8px;align-items:flex-end">
          <div class="qty-controls">
            <button class="small" onclick="changeQuantityInList('${p.id}', -1)">‚àí</button>
            <input id="q_${p.id}" type="number" value="1" min="1" style="width:56px;padding:6px;border-radius:8px;border:1px solid rgba(106,75,42,0.08);text-align:center">
            <button class="small" onclick="changeQuantityInList('${p.id}', 1)">+</button>
          </div>
          <div>
            <button class="btn small" onclick="addToCart('${p.id}', parseInt(document.getElementById('q_${p.id}').value || 1))">Add</button>
          </div>
        </div>
      `;
      container.appendChild(el);
    });
  renderInventory();
}

/* helper for list qty control */
function changeQuantityInList(id, delta){
  const inp = document.getElementById('q_' + id);
  if(!inp) return;
  let val = parseInt(inp.value || 1, 10);
  val = Math.max(1, val + delta);
  inp.value = val;
}

/* ===== cart ops ===== */
function addToCart(productId, quantity = 1){
  const p = findProduct(productId);
  if(!p){ alert('Product not found'); return; }
  quantity = Number(quantity) || 1;
  if(quantity <= 0) return;

  if(p.stock < quantity){
    alert(`Not enough stock for ${p.name}. Available: ${p.stock}`);
    return;
  }

  p.stock -= quantity; // decrease stock

  const row = cart.find(r => r.id === p.id);
  if(row){
    row.qty += quantity;
  } else {
    cart.push({ id: p.id, qty: quantity, price: p.price });
  }
  renderCart();
  autosave();
}

function removeFromCart(index){
  const row = cart[index];
  const p = findProduct(row.id);
  if(p) p.stock += row.qty;
  cart.splice(index,1);
  renderCart();
  autosave();
}

function updateCartQty(index, newQty){
  if(newQty <= 0){ removeFromCart(index); return; }
  const row = cart[index];
  const p = findProduct(row.id);
  if(!p) return;
  const diff = newQty - row.qty;
  if(diff > 0){
    if(p.stock < diff){ alert(`Not enough stock. Available: ${p.stock}`); return; }
    p.stock -= diff;
  } else if(diff < 0){
    p.stock += (-diff);
  }
  row.qty = newQty;
  renderCart();
  autosave();
}

function clearCart(){
  if(!confirm('Clear cart and restore stock?')) return;
  cart.forEach(row => {
    const p = findProduct(row.id);
    if(p) p.stock += row.qty;
  });
  cart = [];
  renderCart();
  autosave();
}

/* ===== totals: subtotal, discount, VAT, total ===== */
function calcTotals(){
  let subtotal = 0;
  cart.forEach(r => {
    const p = findProduct(r.id);
    subtotal += (p.price * r.qty);
  });

  let discountPct = 0;
  const ds = document.getElementById('discountSelect').value;
  if(ds === 'custom'){
    const v = parseFloat(document.getElementById('customDiscount').value || '0');
    discountPct = Math.max(0, Math.min(0.99, v/100));
  } else {
    discountPct = parseFloat(ds) || 0;
  }
  const discountAmt = subtotal * discountPct;

  const vatEnabled = document.getElementById('vatToggle').checked;
  const taxable = subtotal - discountAmt;
  const vat = vatEnabled ? taxable * 0.12 : 0;
  const total = taxable + vat;
  return { subtotal, discountAmt, vat, total, discountPct };
}

/* ===== render cart & totals ===== */
function renderCart(){
  const tbody = document.getElementById('cartBody');
  tbody.innerHTML = '';
  cart.forEach((r, idx) => {
    const p = findProduct(r.id);
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>
        <div style="display:flex;gap:8px;align-items:center">
          <div style="width:36px;height:36px;border-radius:8px;display:flex;align-items:center;justify-content:center;background:#fff3e6;border:1px solid rgba(106,75,42,0.04)">${p.emoji}</div>
          <div>
            <div style="font-weight:700">${p.name}</div>
            <div class="muted" style="font-size:12px">${p.id}</div>
          </div>
        </div>
      </td>
      <td class="center">
        <div style="display:flex;align-items:center;gap:6px;justify-content:center">
          <button class="small" onclick="updateCartQty(${idx}, ${r.qty - 1})">‚àí</button>
          <input type="number" value="${r.qty}" min="1" style="width:48px;padding:4px;border-radius:6px;border:1px solid rgba(106,75,42,0.06);text-align:center" onchange="updateCartQty(${idx}, parseInt(this.value||1))">
          <button class="small" onclick="updateCartQty(${idx}, ${r.qty + 1})">+</button>
        </div>
      </td>
      <td class="center">${currency(p.price)}</td>
      <td class="center">${currency(p.price * r.qty)}</td>
      <td class="center"><button class="small" onclick="removeFromCart(${idx})">X</button></td>
    `;
    tbody.appendChild(tr);
  });

  const { subtotal, discountAmt, vat, total } = calcTotals();
  document.getElementById('subTotalText').innerText = currency(subtotal);
  document.getElementById('discountText').innerText = currency(discountAmt);
  document.getElementById('vatText').innerText = currency(vat);
  document.getElementById('totalText').innerText = currency(total);

  renderInventory();
}

/* ===== inventory widget ===== */
function renderInventory(){
  const el = document.getElementById('inventoryList');
  el.innerHTML = products.map(p => `${p.emoji} ${p.name} (${p.id}): ${p.stock} left`).join(' ‚Ä¢ ');
}

/* ===== barcode (Enter to add) ===== */
document.getElementById('barcodeInput').addEventListener('keypress', function(e){
  if(e.key === 'Enter'){
    const code = this.value.trim();
    if(!code) return;
    const p = findProductByBarcode(code);
    if(!p){
      alert('Barcode not found: ' + code);
    } else {
      addToCart(p.id, 1);
      this.value = '';
    }
  }
});

/* ===== discount control toggles ===== */
document.getElementById('discountSelect').addEventListener('change', function(){
  if(this.value === 'custom'){
    document.getElementById('customDiscount').style.display = 'block';
  } else {
    document.getElementById('customDiscount').style.display = 'none';
  }
  renderCart();
});
document.getElementById('customDiscount').addEventListener('input', renderCart);
document.getElementById('vatToggle').addEventListener('change', renderCart);

/* ===== payment & receipt ===== */
function processPayment(){
  const payment = parseFloat(document.getElementById('paymentInput').value || '0');
  const { total } = calcTotals();
  if(cart.length === 0){ alert('Cart is empty'); return; }
  if(isNaN(payment) || payment <= 0){ alert('Enter a valid payment amount'); return; }
  if(payment < total){
    document.getElementById('paymentResult').innerHTML = `<span style="color:var(--danger)">Not enough payment. Need ${currency(total)}</span>`;
    return;
  }
  const change = payment - total;
  document.getElementById('paymentResult').innerHTML = `<span style="color:var(--success)">Payment successful! Change: ${currency(change)}</span>`;

  const timestamp = new Date().toLocaleString();
  lastReceipt = {
    id: 'RCPT-' + Date.now(),
    timestamp,
    items: cart.map(r => {
      const p = findProduct(r.id);
      return { name: p.name, qty: r.qty, price: p.price, subtotal: p.price * r.qty };
    }),
    totals: calcTotals(),
    payment, change
  };

  fillPrintableReceipt(lastReceipt);
  window.print();

  cart = [];
  renderCart();
  autosave();
}

/* build printable receipt */
function fillPrintableReceipt(receipt){
  const el = document.getElementById('printableReceipt');
  const lines = [];
  lines.push(`<div style="text-align:center;font-weight:800;font-size:18px">JANET SHOP</div>`);
  lines.push(`<div style="text-align:center;font-size:12px;margin-bottom:8px">Bakery POS Receipt<br>${receipt.timestamp}<br>${receipt.id}</div>`);
  lines.push(`<div>------------------------------------------</div>`);
  receipt.items.forEach(it => {
    lines.push(`<div style="display:flex;justify-content:space-between"><div>${it.name} x${it.qty}</div><div>${currency(it.subtotal)}</div></div>`);
  });
  lines.push(`<div>------------------------------------------</div>`);
  lines.push(`<div style="display:flex;justify-content:space-between"><div>Subtotal</div><div>${currency(receipt.totals.subtotal)}</div></div>`);
  lines.push(`<div style="display:flex;justify-content:space-between"><div>Discount</div><div>${currency(receipt.totals.discountAmt)}</div></div>`);
  lines.push(`<div style="display:flex;justify-content:space-between"><div>VAT (12%)</div><div>${currency(receipt.totals.vat)}</div></div>`);
  lines.push(`<div style="display:flex;justify-content:space-between;font-weight:800"><div>Total</div><div>${currency(receipt.totals.total)}</div></div>`);
  lines.push(`<div style="display:flex;justify-content:space-between"><div>Payment</div><div>${currency(receipt.payment)}</div></div>`);
  lines.push(`<div style="display:flex;justify-content:space-between"><div>Change</div><div>${currency(receipt.change)}</div></div>`);
  lines.push(`<div style="text-align:center;margin-top:8px;font-size:12px">Thank you! Enjoy your day üç∞</div>`);
  el.innerHTML = lines.join('');
}

/* print last receipt if available */
function printReceiptFromLast(){
  if(!lastReceipt){ alert('No previous receipt available.'); return; }
  fillPrintableReceipt(lastReceipt);
  window.print();
}

/* export products JSON */
function exportProducts(){
  const blob = new Blob([JSON.stringify(products, null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'products.json'; a.click();
  URL.revokeObjectURL(url);
}

/* demo cart */
function importDemoCart(){
  clearCart();
  addToCart('p001', 2);
  addToCart('p005', 1);
  addToCart('p003', 1);
  document.getElementById('paymentInput').value = '';
}

/* autosave & init */
function autosave(){
  try {
    localStorage.setItem('bakery_pos_cart', JSON.stringify(cart));
    localStorage.setItem('bakery_pos_products', JSON.stringify(products));
    document.getElementById('savedStatus').innerText = 'Yes';
  } catch(e) { console.warn('Autosave failed', e); }
}

(function init(){
  loadCartFromStorage();
  renderProducts();
  renderCart();
})();
</script>
</body>
</html>
